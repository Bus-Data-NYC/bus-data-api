<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bus Transit Data</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <style type="text/css">

    </style>

  </head>
  <body>

  	<div class="container" style="margin-top: 20px">

  		<button class="pull-right btn btn-default" onclick="gohome()"><i class="glyphicon glyphicon-chevron-left"></i> Back</button>
  		
  		<h1><b>Bus Data API</b> <span style="color:grey;font-weight:100">Developer Portal</span></h1>

	  	<div class="form-entries">

				<form class="panel panel-default" id="signin">
					<div class="panel-heading">
						<b>Sign In</b>
					</div>
					<div class="panel-body">
					  <br>Email:
					  <input type="text" id="sign_in_email">
					  Password:
					  <input type="text" id="sign_in_pw">
					  <input class="btn btn-default" type="submit" value="Sign In">
					</div>
				</form>
				
				<br>

				<form class="panel panel-default" id="signup">
					<div class="panel-heading">
						<b>Sign Up</b>
					</div>
					<div class="panel-body">
					  <br>Email:
					  <input type="text" id="sign_up_email">
					  Password:
					  <input type="text" id="sign_up_pw1">
					  Password (re-enter):
					  <input type="text" id="sign_up_pw2">
					  <input class="btn btn-default" type="submit" value="Sign Up">
					</div>
				</form>

				<br>

				<form class="panel panel-default" id="forgot_pw">
					<div class="panel-heading">
						<b>Get your password if you forgot it</b>
					</div>
					<div class="panel-body">
					  <br>Enter the email address associated with the account:
					  <input type="text" id="forgot_pw_email">
					  <input class="btn btn-default" type="submit" value="Send password to account">
					</div>
				</form>

			</div>

			<div class="login-success" style="display:none">
				<p>
					Hello, <span id="user-email"></span>.
					<br>Your password is <span id="user-password"></span>.
					<br>Your token is <span id="user-token"></span>.
				</p>

				<!-- New token success -->
				<span id="new_token_success" style="display:none">
					<i>New token has been created. Re-login to ensure token was properly generated.</i>
					<br><br>
				</span>

				<button class="btn btn-xs btn-warning" onclick="newToken()">
					Get new token
				</button>

				<button class="btn btn-xs btn-danger" onclick="deleteUser()">
					Delete this account
				</button>

			</div>

  	</div>

  </body>
	<script>
		// Globals
		var routes = [];



		// UTILITIES
		function isEmail (email) {
	    var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	    return re.test(email);
		};

		function deleteUser () {
	  	var em = $("#user-email")[0].innerText;
	  	var pw = $("#user-password")[0].innerText;
	  	var address = "/developer/account/" + em + "/" + pw;
			$.ajax({
			  url: address,
			  type: "DELETE",
			  success: function () {
			  	window.location.pathname = "/";
			  },
			  error: function () {
			  	alert("Something happened, account was not deleted.");
			  }
			});
		};	

		function newToken () {
	  	var em = $("#user-email")[0].innerText;
	  	var tk = $("#user-token")[0].innerText;
	  	var pw = $("#user-password")[0].innerText;
	  	$.post("/developer/new_token/", {email: em, password: pw, token: tk})
				.done(function (token) {
				  if (token) {
				  	$("#user-token")[0].innerHTML = "updated. New token is <b>" + token + "</b>";
				  	$("#new_token_success").fadeOut();
				  	$("#new_token_success").fadeIn();
				  } else {
				  	alert("Something happened. Try again.")
				  }
				})
				.fail(function(error) {
				  console.log(error);
				});;
		};

		$("#forgot_pw").submit(function (event) {
			event.preventDefault();
			var email = $("#forgot_pw #forgot_pw_email")[0].value;
			var address = "/developer/email_pw/" + email;
			$.get(address)
				.done(function (data) {
					if (data.email) {
						alert("Email has been sent to " + data.email + ". Check email to access account with password.");
					} else {
						alert("An account with that email does not exist in our system.")
					}
				})
				.fail(function(error) {
				  console.log(error);
				});
		});

		$("#signin").submit(function (event) {
		  event.preventDefault();
		  var email = $("#signin #sign_in_email")[0].value;
		  var password = $("#signin #sign_in_pw")[0].value;
		  if (email == "" || password == "") {
		  	alert("Email or password not entered. Please enter and retry.");
		  } else {
		  	var address = "/developer/account/" + email + "/" + password;
		  	$.get(address)
					.done(function(data) {
					  if (data) {
					  	console.log("S", data);
					  	$(".form-entries").hide();
					  	$("#user-email")[0].innerText = data.email;
					  	$("#user-token")[0].innerText = data.token;
					  	$("#user-password")[0].innerText = data.password;
					  	$(".login-success").show();
					  } else {
					  	console.log("data", data);
					  	alert("Email or password was incorrect. Try again.")
					  }
					})
					.fail(function(error) {
					  console.log(error);
					});

		  }
		});


		$("#signup").submit(function (event) {
		  event.preventDefault();

		  var email = $("#signup #sign_up_email")[0].value;
		  var pw1 = $("#signup #sign_up_pw1")[0].value;
		  var pw2 = $("#signup #sign_up_pw2")[0].value;

		  if (email == "" || pw1 == "" || pw2 == "") {
		  	alert("Email or password not entered. Please enter and retry.");
		  } else if (pw1 !== pw2) {
		  	alert("Password entries do not match. Try again.")
		  } else if (!isEmail(email)) {
		  	alert("Not a valid email address. Try again.")
		  } else {
		  	$.post("/developer/create/", {email: email, password: pw1})
					.done(function(data) {
					  if (data) {
					  	if (data.is_dupe) {
					  		alert("Email address already in use, try a different one.")
					  	} else {
						  	$(".form-entries").hide();
						  	$("#user-email")[0].innerText = email;
						  	$("#user-token")[0].innerText = data.token;
						  	$("#user-password")[0].innerText = pw1;
						  	$(".login-success").show();
					  	}
					  } else {
					  	alert("Something happened. Try again.")
					  }
					})
					.fail(function(error) {
					  console.log(error);
					});

		  }
		});

		function gohome () {
			window.location.pathname = "/";
		};




	</script>
</html>


