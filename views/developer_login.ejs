<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Bus Transit Data</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/typeahead.js/0.11.1/typeahead.bundle.min.js"></script>

    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" rel="stylesheet">

    <style type="text/css">
    </style>

  </head>
  <body>

  	<div class="container" style="margin-top: 20px">

  		<h1>
  			<b onclick="gohome()" style="cursor:pointer">
  				Bus Data API
  			</b>  
  			<span style="color:grey;font-weight:100">Developer Portal</span>
  		</h1>

	  	<div class="row form-entries">

		  	<div class="col-xs-12 col-sm-6">
					<form class="panel panel-default form-horizontal" id="signin">
						<div class="panel-heading">
							<b>Sign In</b>
						</div>
						<div class="panel-body">
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Email</label>
						    <div class="col-sm-9">
						      <input type="email" class="form-control" id="sign_in_email" placeholder="Email">
						    </div>
						  </div>

						  <div class="form-group">
						    <label class="col-sm-3 control-label">Password</label>
						    <div class="col-sm-9">
						      <input type="password" class="form-control" id="sign_in_pw" placeholder="Password">
						    </div>
						  </div>

						  <input class="btn btn-success pull-right" type="submit" value="Sign In">
						</div>
					</form>

					<form class="panel panel-default form-horizontal" id="forgot_pw">
						<div class="panel-heading">
							<b>Get your password if you forgot it</b>
						</div>
						<div class="panel-body">
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Email</label>
						    <div class="col-sm-9">
						      <input type="email" class="form-control" id="forgot_pw_email" placeholder="Email">
						    </div>
						  </div>

						  <input class="btn btn-warning pull-right" type="submit" value="Send password to email">
						</div>
					</form>
				</div>

				<div class="col-xs-12 col-sm-6">
					<form class="panel panel-default form-horizontal" id="signup">
						<div class="panel-heading">
							<b>Sign Up</b>
						</div>
						<div class="panel-body">
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Email</label>
						    <div class="col-sm-9">
						      <input type="email" class="form-control" id="sign_up_email" placeholder="Email">
						    </div>
						  </div>
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Organization</label>
						    <div class="col-sm-9">
						      <input type="text" class="form-control" id="sign_up_org" placeholder="Organization/Affilliation">
						    </div>
						  </div>
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Password</label>
						    <div class="col-sm-9">
						      <input type="password" class="form-control" id="sign_up_pw1" placeholder="Password">
						    </div>
						  </div>
						  
						  <div class="form-group">
						    <label class="col-sm-3 control-label">Re-enter</label>
						    <div class="col-sm-9">
						      <input type="password" class="form-control" id="sign_up_pw2" placeholder="Password (re-enter)">
						    </div>
						  </div>

						  <input class="btn btn-info pull-right" type="submit" value="Sign Up">
						</div>
					</form>
				</div>

			</div>

			<div class="login-success" style="display:none">
				<p>
					Hello, <span id="user-email"></span>.
					<br><span id="user-password"></span>.
					<br><span id="user-token"></span>.
				</p>

				<!-- New token success -->
				<span id="new_token_success" style="display:none">
					<i>New token has been created. Re-login to ensure token was properly generated.</i>
					<br><br>
				</span>

				<button class="btn btn-xs btn-warning" onclick="newToken()">
					Get new token
				</button>

				<button class="btn btn-xs btn-danger" onclick="deleteUser()">
					Delete this account
				</button>

			</div>

  	</div>

  </body>
	<script>
		//GLOBALS
		var g = {password: null, email: null, token: null};

		// UTILITIES
		function isEmail (email) {
	    var re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
	    return re.test(email);
		};

		function deleteUser () {
			if (confirm("Are you sure you want to delete this account?")) {
		  	var em = g.email;
		  	var pw = g.password;
		  	var address = "/developer/account/" + em + "/" + pw;

		  	$("#new_token_success").fadeOut();
		  	$("#new_token_success")[0].innerHTML = "<i>Please wait... Delete operation can take a few seconds.</i><br><br>"
		  	$("#new_token_success").fadeIn();

				$.ajax({
				  url: address,
				  type: "DELETE",
				  success: function () {
				  	window.location.pathname = "/";
				  },
				  error: function () {
				  	alert("Something happened, account was not deleted.");
				  }
				});
			}
		};	

		function newToken () {
	  	var em = g.email;
	  	var tk = g.token;
	  	var pw = g.password;
	  	$.post("/developer/new_token/", {email: em, password: pw, token: tk})
				.done(function (token) {
				  if (token) {
				  	$("#user-token")[0].innerHTML = "Your token is updated. New token is <b>" + token + "</b>";
				  	$("#new_token_success").fadeOut();
				  	$("#new_token_success").fadeIn();
				  } else {
				  	alert("Something happened. Try again.")
				  }
				})
				.fail(function(error) {
				  console.log(error);
				});;
		};

		$("#forgot_pw").submit(function (event) {
			event.preventDefault();
			var email = g.email;
			var address = "/developer/email_pw/" + email;
			$.get(address)
				.done(function (data) {
					if (data.email) {
						alert("Email has been sent to " + data.email + ". Check email to access account with password.");
					} else {
						alert("An account with that email does not exist in our system.")
					}
				})
				.fail(function(error) {
				  console.log(error);
				});
		});

		$("#signin").submit(function (event) {
		  event.preventDefault();
		  var email = $("#signin #sign_in_email")[0].value;
		  var password = $("#signin #sign_in_pw")[0].value;
		  if (email == "" || password == "") {
		  	alert("Email or password not entered. Please enter and retry.");
		  } else {
		  	var address = "/developer/account/" + email + "/" + password;
		  	$.get(address)
					.done(function(data) {
					  if (data) {
					  	$(".form-entries").hide();

					  	$("#user-email")[0].innerText = data.email;
					  	$("#user-token")[0].innerText = "Your token is " + data.token;
					  	$("#user-password")[0].innerText = "Your password is " + data.password;

					  	g.email = data.email;
					  	g.token = data.token;
					  	g.password = data.password;
					  	
					  	$(".login-success").show();
					  } else {
					  	console.log("data", data);
					  	alert("Email or password was incorrect. Try again.")
					  }
					})
					.fail(function(error) {
					  console.log(error);
					});

		  }
		});


		$("#signup").submit(function (event) {
		  event.preventDefault();

		  var email = $("#signup #sign_up_email")[0].value;
		  var org = $("#signup #sign_up_org")[0].value;
		  var pw1 = $("#signup #sign_up_pw1")[0].value;
		  var pw2 = $("#signup #sign_up_pw2")[0].value;

		  if (email == "" || org == "" || pw1 == "" || pw2 == "") {
		  	alert("Email or password not entered. Please enter and retry.");
		  } else if (pw1 !== pw2) {
		  	alert("Password entries do not match. Try again.")
		  } else if (!isEmail(email)) {
		  	alert("Not a valid email address. Try again.")
		  } else {
		  	$.post("/developer/create/", {email: email, password: pw1, org: org})
					.done(function(data) {
					  if (data) {
					  	if (data.is_dupe) {
					  		alert("Email address already in use, try a different one.")
					  	} else {
						  	$(".form-entries").hide();

						  	$("#user-email")[0].innerText = email;
						  	$("#user-token")[0].innerText = "Your token is " + data.token;
						  	$("#user-password")[0].innerText = "Your password is " + pw1;

						  	g.email = email;
						  	g.token = data.token;
						  	g.password = pw1;

						  	$(".login-success").show();
					  	}
					  } else {
					  	alert("Something happened. Try again.")
					  }
					})
					.fail(function(error) {
					  console.log(error);
					});

		  }
		});

		function gohome () {
			window.location.pathname = "/";
		};




	</script>
</html>


